---
layout: post
title: "ìª½ì§€ ë³´ë‚´ê¸° ê¸°ëŠ¥í•˜ë‚˜ì— ì´ë ‡ê²Œ ë§ì€ ê³ ë¯¼ì´??"
date: 2024-09-17 13:00:00 +0900
categories: jekyll update
---

### ğŸ˜ìª½ì§€ ë³´ë‚´ê¸° ê¸°ëŠ¥í•˜ë‚˜ì— ì´ë ‡ê²Œ ë§ì€ ê³ ë¯¼ì´?? <br/> Firebaseì™€ Reactë¡œ ìª½ì§€ ê¸°ëŠ¥ ì™„ì„±í•˜ê¸°

ê°œë°œìë¼ë©´, ì‘ì€ ê¸°ëŠ¥ í•˜ë‚˜ë¥¼ êµ¬í˜„í•  ë•Œë„ ì˜ˆìƒë³´ë‹¤ ë§ì€ ê³ ë¯¼ì´ í•„ìš”í•˜ë‹¤ëŠ” ê±¸ ê²½í—˜í•´ ë³´ì…¨ì„ ê²ë‹ˆë‹¤. ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” ì¤‘ê³ ê±°ë˜ í”Œë«í¼ì—ì„œ **ìª½ì§€ ë³´ë‚´ê¸° ê¸°ëŠ¥**ì„ êµ¬í˜„í•˜ë©´ì„œ ê²ªì€ ê³ ë¯¼ê³¼ í•´ê²° ê³¼ì •ì„ ê³µìœ í•˜ë ¤ í•©ë‹ˆë‹¤.

ì¤‘ê³  ê±°ë˜ í”Œë«í¼ì—ì„œ êµ¬ë§¤ìì™€ íŒë§¤ìê°€ ììœ ë¡­ê²Œ ëŒ€í™”í•  ìˆ˜ ìˆëŠ” ìª½ì§€ ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ ë‹¨ìˆœí•´ ë³´ì´ì§€ë§Œ, ìƒíƒœ ê´€ë¦¬ì™€ ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ì„¤ê³„ì— ë§ì€ ê³ ë¯¼ì´ í•„ìš”í–ˆìŠµë‹ˆë‹¤. íŠ¹íˆ **ì‚¬ìš©ì ê´€ì **ì—ì„œì˜ í”Œë¡œìš°ì™€ ì´ë¥¼ **ì‹œìŠ¤í…œ ë™ì‘**ì— ë§ê²Œ êµ¬í˜„í•˜ëŠ” ê³¼ì •ì—ì„œ ë§ì€ ì‹œí–‰ì°©ì˜¤ê°€ ìˆì—ˆìŠµë‹ˆë‹¤.

<img src='/images/2-8-bokuto8.png' alt='ì‹œì‘í•˜ê¸°' style="margin: 20px 0"/>

### ğŸ©·1. ìª½ì§€ ë³´ë‚´ê¸° ê¸°ëŠ¥ ì„¤ê³„ ê³¼ì •

ìª½ì§€ ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ êµ¬ë§¤ìì™€ íŒë§¤ìê°€ ì„œë¡œ ë©”ì‹œì§€ë¥¼ ì£¼ê³ ë°›ëŠ” ê¸°ë³¸ì ì¸ ì†Œí†µ ì°½êµ¬ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ ë¡œê·¸ì¸í•œ ìœ ì €ì˜ ì—­í• ê³¼ ì´ì „ ìª½ì§€ ì—¬ë¶€ì— ë”°ë¼ ë²„íŠ¼ì´ ë‹¬ë¼ì ¸ì•¼ í•˜ëŠ” ë¡œì§ì€ ê½¤ ë³µì¡í–ˆìŠµë‹ˆë‹¤. 

ì²˜ìŒ ìª½ì§€ ë³´ë‚´ê¸° ê¸°ëŠ¥ì„ ê°œë°œí•  ë•Œ, ë¬´ì‘ì • â€˜ìª½ì§€ ë³´ë‚´ê¸°â€™ë¼ëŠ” ê¸°ëŠ¥ì—ë§Œ ì§‘ì¤‘í•´ **ìœ ì € í”Œë¡œìš°**ì— ëŒ€í•´ ê¹Šê²Œ ìƒê°í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê·¸ ê²°ê³¼, ê¸°ëŠ¥ì€ ì™„ì„±í–ˆì§€ë§Œ ë•ì§€ë•ì§€ ë¶™ì—¬ì§„ ì½”ë“œì™€ ì¤‘ë³µëœ ë¡œì§ì´ ë§ì•˜ìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ v2ì—ì„œëŠ” ì²˜ìŒë¶€í„° ìœ ì € í”Œë¡œìš°ë¥¼ ì¶©ë¶„íˆ ê³ ë ¤í•œ ë’¤, ë³´ë‹¤ ì²´ê³„ì ìœ¼ë¡œ ê°œë°œì„ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.<br/>
**ì‚¬ìš©ì ê´€ì ì˜ í”Œë¡œìš°**ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤: <br/>

<img src='/images/0917_flow.png' alt='ì‹œì‘í•˜ê¸°' style="margin: 10px auto; display:block; width: 400px"/>

- ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ **íŒë§¤ì**ë¼ë©´, 'ìª½ì§€ ë³´ë‚´ê¸°' ë²„íŠ¼ì€ ìˆ¨ê¸°ê³ 
- **êµ¬ë§¤ì**ë¼ë©´ 'ìª½ì§€ ë³´ë‚´ê¸°' ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
- ì´ì „ì— í•´ë‹¹ ì œí’ˆì— ëŒ€í•œ ëŒ€í™”ê°€ ìˆì—ˆë‹¤ë©´, ë²„íŠ¼ ë¬¸êµ¬ê°€ 'ìª½ì§€ ì´ì–´í•˜ê¸°'ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.
- ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ìª½ì§€ í˜ì´ì§€ë¡œ ì´ë™í•˜ê³ , ì´ í˜ì´ì§€ì—ì„œëŠ” íŒë§¤ì, êµ¬ë§¤ì, ì œí’ˆ ì •ë³´ ë° ëŒ€í™” ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤.

ì´ì²˜ëŸ¼ UIì—ì„œ ë³´ì´ëŠ” ë¶€ë¶„ì„ ë¨¼ì € êµ¬ìƒí•œ í›„, ì‹œìŠ¤í…œì ìœ¼ë¡œ ì´ íë¦„ì„ ì–´ë–»ê²Œ ì²˜ë¦¬í• ì§€ ê³ ë¯¼í–ˆìŠµë‹ˆë‹¤. ì‹œìŠ¤í…œ ë™ì‘ì€ ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì¡°ë¥¼ ë”°ëìŠµë‹ˆë‹¤

| **ì‚¬ìš©ì í”Œë¡œìš°**                           | **ì‹œìŠ¤í…œ í”Œë¡œìš°**                                                      |
| ------------------------------------------- | ---------------------------------------------------------------------- |
| - êµ¬ë§¤ìì¼ ê²½ìš° 'ìª½ì§€ ë³´ë‚´ê¸°' ë²„íŠ¼ ë…¸ì¶œ     | êµ¬ë§¤ì/íŒë§¤ì ì—¬ë¶€ í™•ì¸ í›„ ë²„íŠ¼ ë…¸ì¶œ ê²°ì •                              |
| - ì´ì „ ëŒ€í™”ê°€ ìˆë‹¤ë©´ 'ìª½ì§€ ì´ì–´í•˜ê¸°'ë¡œ ë³€ê²½ | ìª½ì§€ ë°ì´í„° ì—¬ë¶€ í™•ì¸ í›„, ë²„íŠ¼ ë¬¸êµ¬ë¥¼ ë™ì ìœ¼ë¡œ ë³€ê²½                    |
| - ë²„íŠ¼ í´ë¦­ ì‹œ ìª½ì§€ í˜ì´ì§€ ì´ë™             | í´ë¦­ ì‹œ `messageId` ìƒì„± í›„ URL ì´ë™ ë° DB ì €ì¥ (ì´ì „ ìª½ì§€ ì—†ëŠ” ê²½ìš° ) |

<br/>

### ğŸ©·2. Firebase í…Œì´ë¸” êµ¬ì¡° ë° API ì„¤ê³„

**(1-1) v1 messages dbêµ¬ì¡° ë° ë°ì´í„° ì €ì¥**
- ìª½ì§€ ë³´ë‚´ê¸° ë²„íŠ¼ í´ë¦­ì‹œ ìª½ì§€ë°©ì´ ìƒì„±ë˜ëŠ”ë°, ì´ë•Œ íŒë§¤/êµ¬ë§¤ì/ì œí’ˆì˜ ì •ë³´ë¥¼ í•¨ê»˜ dbì— ì €ì¥í–ˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ìœ ì €ë‚˜ ì œí’ˆ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ ë˜ì—ˆì„ ê²½ìš°ì— **ì—…ë°ì´íŠ¸ ëœ ë‚´ìš©ì„ ë°˜ì˜í•˜ê¸° ì–´ë ¤ì›€**ì´ ìˆì—ˆìŠµë‹ˆë‹¤.

```tsx
// v1ì—ì„œì˜ ìª½ì§€ ë°ì´í„° ì €ì¥ ë°©ì‹ ( ê´€ë ¨ ë°ì´í„° ëª¨ë‘ ì €ì¥ )
 const onClickAddMessagePage = async () => {
    const messageId = uuidv4();
    if (!currentMessage) {
      const messageData: MessagesType = {
        messageId: messageId,
        itemId,
        ... // ì œí’ˆ ì •ë³´ ë°ì´í„° ,
        seller : { // íŒë§¤ì ì •ë³´ ë°ì´í„° }
        buyer : { // êµ¬ë§¤ì ì •ë³´ ë°ì´í„° }
        salesStatus: "initialization",
      };
      await addUsedMessagePage(messageData);
    }
    navigate(`/message/${itemId}/${userId}`, { state: { // ë©”ì„¸ì§€ í˜ì´ì§€ì—ì„œ ë³´ì—¬ì§ˆ ë°ì´í„°ë“¤ },
    });
  };
```
<br/>

- v1ì—ì„œëŠ” messagesì˜ ë‚´ìš©ì„ userDataì— ì €ì¥í•´ë†¨ê¸° ë•Œë¬¸ì— **êµ¬ë§¤ìì™€ íŒë§¤ì ëª¨ë‘ì—ê²Œ ë©”ì„¸ì§€ë¥¼ ì €ì¥**í•´ì•¼ í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” ë°ì´í„° ì¤‘ë³µê³¼ ë¹„íš¨ìœ¨ì ì¸ ê´€ë¦¬ ë¬¸ì œë¥¼ ì¼ìœ¼ì¼°ìŠµë‹ˆë‹¤.

```tsx
// ìª½ì§€ í˜ì´ì§€ ìƒì„± => íŒë§¤ì, êµ¬ë§¤ìëª¨ë‘ ê°™ì€ ë°ì´í„° ì €ì¥
export async function addUsedMessagePage(messageData: MessagesType) {
  const { seller, buyer, messageId } = messageData;
  try {
    const updates = {
      [`/userData/${seller.sellerId}/messages/${messageId}`]: messageData,
      [`/userData/${buyer.userId}/messages/${messageId}`]: messageData,
    };
    await update(ref(database), updates);
  } catch (err) {
    console.error("ë©”ì„¸ì§€ ìƒì„± ì—ëŸ¬", err);
  }
}
```
<br/>

**(1- 2) v2 messages dbêµ¬ì¡° ë° ë°ì´í„° ì €ì¥**<br/>
- ìœ„ì™€ ê°™ì€ êµ¬ì¡°ëŠ” ê´€ë¦¬í•˜ê¸°ì— ë„ˆë¬´ ë³µì¡í–ˆê¸°ì—, v2ì—ì„œëŠ” **ë°ì´í„° ë¶„ë¦¬**ì™€ **ìµœì í™”**ì— ì¤‘ì ì„ ë‘ì—ˆìŠµë‹ˆë‹¤. ë¨¼ì € usedMessages ë¼ëŠ” ë°ì´í„° í…Œì´ë¸”ì„ ë”°ë¡œ ìƒì„±í•˜ì—¬ ìœ ì € ë°ì´í„°ì™€ messagesë¥¼ ë¶„ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.


- ìª½ì§€ í˜ì´ì§€ì—ì„œ íŒë§¤ì / êµ¬ë§¤ì / ì œí’ˆ ì •ë³´ëŠ” idë¡œë§Œ ì €ì¥í•˜ì—¬ ë³„ë„ì˜ APIìš”ì²­ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ëŠ” ë°©ì‹ì„ ì„ íƒí•˜ì˜€ìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ìª½ì§€ ë³´ë‚´ê¸° í˜ì´ì§€ì—ì„œëŠ” ìµœì‹  ë°ì´í„°ë¥¼ ë³´ì¥í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

```tsx
// v2ì—ì„œì˜ ìª½ì§€ ë°ì´í„° ì €ì¥ ë°©ì‹ ( ê´€ë ¨ idë§Œ ì €ì¥ )
const onClickAddMessage = async () => {
  const messageId = uuidv4();
  if (previousMessage === null) {
    const messageData = {
      messageId,
      productId,
      sellerId: usedProduct.seller._id,
      buyerId: isLoginUser._id,
      createdAt: utcToKoreaTimes(),
    };
    await addMessagesPage(messageData); // ë°ì´í„° ì¤‘ë³µ ì—†ì´ ì €ì¥
  }
  navigate(`/message/${productId}/${messageId}`);
};
```

```tsx
// ìª½ì§€ í˜ì´ì§€ ìƒì„± => usedMessagesí…Œì´ë¸”ì— ì €ì¥ => ìœ ì €ëŠ” messageIdë§Œ ì €ì¥í•´ ë‘ë©´ ë¨
export const addMessagesPage = async (messageData: MessageType) => {
  try {
    const getUserMessageList = async (userId: string) => {
      const snapshot = await get(ref(database, `users/${userId}`));
      if (snapshot.exists()) {
        const userData = snapshot.val();
        return userData.listMessages || [];
      }
      return [];
    };

    // íŒë§¤ìì™€ êµ¬ë§¤ìì˜ ê¸°ì¡´ ë©”ì‹œì§€ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const sellerPrevMessages = await getUserMessageList(messageData.sellerId);
    const buyerPrevMessages = await getUserMessageList(messageData.buyerId);

    // íŒë§¤ìì™€ êµ¬ë§¤ìì˜ ë©”ì‹œì§€ì— ìƒˆ ë©”ì‹œì§€ID ì¶”ê°€
    const sellerUpdatedMessages = [
      ...sellerPrevMessages,
      messageData.messageId,
    ];
    const buyerUpdatedMessages = [...buyerPrevMessages, messageData.messageId];

    const updates = {
      [`usedMessages/${messageData.messageId}`]: { ...messageData },
      [`users/${messageData.sellerId}/listMessages`]: sellerUpdatedMessages,
      [`users/${messageData.buyerId}/listMessages`]: buyerUpdatedMessages,
    };
    console.log("ìª½ì§€ í˜ì´ì§€ ìƒì„± ì„±ê³µ");
    await update(ref(database), updates);
  } catch (error) {
    console.error("ìª½ì§€ í˜ì´ì§€ ìƒì„±ì‹¤íŒ¨", error);
  }
};
```

ì´ë ‡ê²Œ Firebase í…Œì´ë¸” êµ¬ì¡°ë¥¼ ê°œì„ í•œ ë•ë¶„ì— ë°ì´í„° ì¤‘ë³µ ë¬¸ì œë¥¼ í•´ê²°í–ˆê³ , í•„ìš”í•œ ë°ì´í„°ë§Œ íš¨ìœ¨ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” êµ¬ì¡°ë¡œ ë§Œë“¤ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. 
<br/>
<br/>


### ğŸ©·3. ë¡œë”© ìƒíƒœ ê´€ë¦¬ UI ê°œì„ 

ìœ ì €ê°€ ìƒì„¸í˜ì´ì§€ë¡œ ë“¤ì–´ì™”ì„ ë•Œ, í•´ë‹¹ ì œí’ˆì— ëŒ€í•œ ìª½ì§€ê°€ ìˆì—ˆë‹¤ë©´, ìª½ì§€ ë³´ë‚´ê¸° ë²„íŠ¼ ë¬¸êµ¬ê°€ 'ìª½ì§€ ì´ì–´í•˜ê¸°'ë¡œ ë³€ê²½ë˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í–ˆì—ˆìŠµë‹ˆë‹¤. ì´ ë•Œ, ìª½ì§€ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” ë™ì•ˆ ì‹œê°„ì´ ê±¸ë ¤ í˜ì´ì§€ ë Œë”ë§ í›„ì— ë¬¸êµ¬ê°€ ë³€ê²½ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

ì´ë¥¼ ê°œì„ í•˜ê¸° ìœ„í•´ `isLoadingMessage`ë¼ëŠ” ìƒíƒœë¥¼ ì¶”ê°€í•˜ê³ , ë©”ì‹œì§€ ë°ì´í„°ë¥¼ í™•ì¸í•˜ëŠ” ë™ì•ˆ ë¡œë”© ì¤‘ì„ì„ ë‚˜íƒ€ë‚´ì—ˆìŠµë‹ˆë‹¤.

ì´ ê³¼ì •ì„ í†µí•´ ë²„íŠ¼ ë¬¸êµ¬ê°€ ë’¤ëŠ¦ê²Œ ë³€ê²½ë˜ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ê³ , í˜ì´ì§€ê°€ ì²˜ìŒ ë¡œë“œë  ë•ŒëŠ” ë¡œë”© ìŠ¤í”¼ë„ˆë¥¼ í‘œì‹œí•¨ìœ¼ë¡œì¨ ì‚¬ìš©ìê°€ ë¶ˆí¸í•¨ì„ ëŠë¼ì§€ ì•Šë„ë¡ UIë¥¼ ë”ìš± ë§¤ë„ëŸ½ê²Œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.

```tsx
export const UsedProductsDetail = () => {
  const [isLoadingMessage, setIsLoadingMessage] = useState(true);

  useEffect(() => {
    const checkPreviousMessage = async () => {
      const result = await checkMessage({
        buyerId: isLoginUser._id,
        productId: productId as string,
      });
      if (result !== null) setPreviousMessage(result);
      setIsLoadingMessage(false);
    };
    checkPreviousMessage();
  }, []);

  return (
    <>
      {buyer &&
        (!isLoadingMessage ? (
          <button onClick={onClickAddMessage} className="p-2 border">
            {previousMessage !== null ? "ìª½ì§€ ì´ì–´í•˜ê¸°" : "ìª½ì§€ ë³´ë‚´ê¸°"}
          </button>
        ) : (
          <LoadingSpinner size="4" />
        ))}
    </>
  );
};
```
<br/>

### ğŸ©·ëŠë‚€ì 

ì´ë²ˆ ìª½ì§€ ë³´ë‚´ê¸° ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ë©´ì„œ ë‹¨ìˆœíˆ ê¸°ëŠ¥ì„ ë§Œë“œëŠ” ê²ƒì´ ì•„ë‹ˆë¼, **ì‚¬ìš©ìì™€ ì‹œìŠ¤í…œì˜ ë™ì‘ íë¦„ì„ ëª¨ë‘ ê³ ë ¤í•´ì•¼ í•œë‹¤ëŠ” ê²ƒì„ ê¹¨ë‹¬ì•˜ìŠµë‹ˆë‹¤.** Firebase ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì¬ì„¤ê³„í•˜ê³ , URL êµ¬ì¡° ë³€ê²½ê³¼ ë¡œë”© ìƒíƒœ ê´€ë¦¬ë¥¼ í†µí•´ ì‚¬ìš©ì ê²½í—˜ì„ ìµœì í™”í•œ ì ì€ í° ì„±ê³¼ì˜€ìŠµë‹ˆë‹¤.

ì²˜ìŒì—ëŠ” ë‹¨ìˆœí•´ ë³´ì˜€ë˜ ê¸°ëŠ¥ì´ì—ˆì§€ë§Œ, **í•˜ë‚˜í•˜ë‚˜ ëœ¯ì–´ë³´ë©° ê°œë°œí•˜ëŠ” ê³¼ì •ì´ ì¦ê±°ì› ê³ , ë¦¬íŒ©í† ë§ì„ í†µí•´ ë” ë‚˜ì€ ë°©í–¥ìœ¼ë¡œ ë°œì „ì‹œí‚¬ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.** ì•ìœ¼ë¡œë„ ì´ëŸ¬í•œ ê³ ë¯¼ê³¼ ì‹œë„ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë” ë‚˜ì€ ê°œë°œìê°€ ë˜ê¸° ìœ„í•´ ë…¸ë ¥í•  ê²ƒì…ë‹ˆë‹¤.
